<?php

namespace BL\Entity\Repository;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Tools\Pagination\Paginator;

/**
 * ProductDesignRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ProductDesignRepository extends EntityRepository {

    /**
     * Function to Get Designs by approval
     * @author Tanzim
     * @copyright Blueliner Marketing
     * @version 0.1
     * @access public
     * @return Array of owner_id
     */
    public function getDesignByApproval($pg = 1, $vendor_id='', $is_approved = 0, $start_date='', $end_date='', $itemPerPage = 1) {

        if ($vendor_id != '' || $vendor_id != NULL) {
            if ($is_approved == -1) { // All Design (Pending - Approved - Rejected)
                if (($start_date != '' || $start_date != NULL) && ($end_date != '' || $end_date != NULL))
                    $q = $this->_em->createQuery('SELECT pd FROM BL\Entity\ProductDesign pd ' . "WHERE pd.owner_id = '$vendor_id' AND pd.upload_date BETWEEN '$start_date' AND '$end_date' ORDER BY pd.is_approved ASC , pd.upload_date DESC");
                else
                    $q = $this->_em->createQuery('SELECT pd FROM BL\Entity\ProductDesign pd ' . "WHERE pd.owner_id = '$vendor_id' ORDER BY pd.is_approved ASC , pd.upload_date DESC");
            }
            else {
                if (($start_date != '' || $start_date != NULL) && ($end_date != '' || $end_date != NULL))
                    $q = $this->_em->createQuery('SELECT pd FROM BL\Entity\ProductDesign pd ' . "WHERE pd.owner_id = '$vendor_id' AND pd.is_approved = '$is_approved' AND pd.upload_date BETWEEN '$start_date' AND '$end_date' ORDER BY pd.upload_date DESC");
                else
                    $q = $this->_em->createQuery('SELECT pd FROM BL\Entity\ProductDesign pd ' . "WHERE pd.owner_id = '$vendor_id' AND pd.is_approved = '$is_approved'" . ' ORDER BY pd.upload_date ' . ($is_approved == 0 ? 'ASC' : 'DESC'));
            }
        }
        else { // Null Vendor
            if ($is_approved == -1) { // All Design (Pending - Approved - Rejected)
                if (($start_date != '' || $start_date != NULL) && ($end_date != '' || $end_date != NULL))
                    $q = $this->_em->createQuery('SELECT pd FROM BL\Entity\ProductDesign pd ' . "WHERE pd.upload_date BETWEEN '$start_date' AND '$end_date' ORDER BY pd.is_approved ASC , pd.upload_date DESC");
                else
                    $q = $this->_em->createQuery('SELECT pd FROM BL\Entity\ProductDesign pd ORDER BY pd.is_approved ASC , pd.upload_date DESC');
            }
            else {
                if (($start_date != '' || $start_date != NULL) && ($end_date != '' || $end_date != NULL))
                    $q = $this->_em->createQuery('SELECT pd FROM BL\Entity\ProductDesign pd ' . "WHERE pd.is_approved = '$is_approved' AND pd.upload_date BETWEEN '$start_date' AND '$end_date' ORDER BY pd.upload_date DESC");
                else
                    $q = $this->_em->createQuery("SELECT pd FROM BL\Entity\ProductDesign pd WHERE pd.is_approved = '" . $is_approved . "' ORDER BY pd.upload_date " . ($is_approved == 0 ? 'ASC' : 'DESC'));
            }
        }
        /*         * * 
         * Doctrine Paginator needs to be converted to one of the adapters Zend Paginator accepts. So
         * we're using Zend_Pagination_Adapter_Iterator adapter to inject the dependency.
         */
        $doctrine_paginator = new Paginator($q);
        $doctrine_paginator_iterator = $doctrine_paginator->getIterator(); // returns \ArrayIterator object
        $adapter = new \Zend_Paginator_Adapter_Iterator($doctrine_paginator_iterator);
        $records = new \Zend_Paginator($adapter);
        $records->setCurrentPageNumber($pg)
                ->setItemCountPerPage($itemPerPage);
        return $records;
    }

    /**
     * Function to Get Distinct Owners
     * @author Tanzim
     * @copyright Blueliner Marketing
     * @version 0.1
     * @access public
     * @return Array of owner_id
     */
    public function getDistinctOwners($IsApproved = -1) {
        $q = $this->_em->getConnection();
        if ($IsApproved == -1)
            return $q->fetchAll("SELECT DISTINCT(owner_id) FROM product_designs ORDER BY upload_date ASC");
        else
            return $q->fetchAll("SELECT DISTINCT(owner_id) FROM product_designs WHERE is_approved = '" . $IsApproved . "'  ORDER BY upload_date ASC");
    }

    /**
     * Function to Get Designs by tags
     * @author Tanzim
     * @copyright Blueliner Marketing
     * @version 0.1
     * @access public
     * @return Array of owner_id
     */
    public function getDesignByTags($pg = 1, $vendor_id='', $is_approved = 0, $start_date='', $end_date='', $param ="", $itemPerPage = 1) {
        $con = $this->_em->getConnection();
        $condition = "";
        if ($vendor_id != '' || $vendor_id != NULL) {
            if ($is_approved == -1) { // All Design (Pending - Approved - Rejected)
                if (($start_date != '' || $start_date != NULL) && ($end_date != '' || $end_date != NULL)) {
                    $condition = "pd.owner_id = '$vendor_id' AND pd.upload_date BETWEEN '$start_date' AND '$end_date' AND";
                } else {
                    $condition = "pd.owner_id = '$vendor_id' AND";
                }
            } else {
                if (($start_date != '' || $start_date != NULL) && ($end_date != '' || $end_date != NULL)) {
                    $condition = "pd.owner_id = '$vendor_id' AND pd.is_approved = '$is_approved' AND pd.upload_date BETWEEN '$start_date' AND '$end_date' AND";
                } else {
                    $condition = "pd.owner_id = '$vendor_id' AND pd.is_approved = '$is_approved' AND";
                }
            }
        } else {
            if ($is_approved == -1) { // All Design (Pending - Approved - Rejected)
                if (($start_date != '' || $start_date != NULL) && ($end_date != '' || $end_date != NULL)) {
                    $condition = "pd.upload_date BETWEEN '$start_date' AND '$end_date' AND";
                } else {
                    $condition = "";
                }
            } else {
                if (($start_date != '' || $start_date != NULL) && ($end_date != '' || $end_date != NULL)) {
                    $condition = "pd.is_approved = '$is_approved' AND pd.upload_date BETWEEN '$start_date' AND '$end_date' AND";
                } else {
                    $condition = "pd.is_approved = '$is_approved' AND";
                }
            }
        }

        $result = $con->fetchAll("SELECT pd.id, pd.owner_id, pd.file_url, pd.note_from_admin, pd.is_approved, pd.upload_date, pd.product_id, pd.description, u.organization_name, u.id AS user_id 
                            FROM users AS u 
                            INNER JOIN product_designs AS pd 
                            ON pd.owner_id = u.id
                            WHERE " . $condition . " pd.id IN (
                            SELECT DISTINCT(pddt.product_design_id)
                            FROM product_designs_design_tags AS pddt
                            INNER JOIN design_tags AS dt
                            ON pddt.design_tag_id = dt.id AND LOWER (dt.tag_name) LIKE LOWER('%$param%') )");

        $records = \Zend_Paginator::factory($result);
        $records->setItemCountPerPage($itemPerPage)->setCurrentPageNumber($pg);
        return $records;
    }

    /**
     * Function to get vendor product design
     * @author Tanzim
     * @copyright Blueliner Marketing
     * @version 0.1
     * @access public
     * @param array $param
     * @return String
     */
    public function getVednorDesigns($params) {
        $is_approved = isset($params['is_approved']) ? " AND pd.is_approved = '" . $params['is_approved'] . "'" : '';
        $sql = "SELECT pd FROM BL\Entity\ProductDesign pd WHERE pd.owner_id = " . $params['owner_id'] . $is_approved . " ORDER BY pd.is_approved";
        $q = $this->_em->createQuery($sql);
        /*         * * 
         * Doctrine Paginator needs to be converted to one of the adapters Zend Paginator accepts. So
         * we're using Zend_Pagination_Adapter_Iterator adapter to inject the dependency.
         */
        $doctrine_paginator = new Paginator($q);
        $doctrine_paginator_iterator = $doctrine_paginator->getIterator(); // returns \ArrayIterator object
        $adapter = new \Zend_Paginator_Adapter_Iterator($doctrine_paginator_iterator);
        $records = new \Zend_Paginator($adapter);
        $records->setCurrentPageNumber($params['page'])
                ->setItemCountPerPage($params['per_page']);
        return $records;
    }

    /**
     * Function to Total Designs Counter
     * @author Tanzim
     * @copyright Blueliner Marketing
     * @version 0.1
     * @access public
     * @return Array of owner_id
     */
    public function getDesignTypeCounter($vendor_id='', $is_approved = 0, $start_date='', $end_date='', $param ="") {
        $connection = $this->_em->getConnection();

        $condition = "";
        if ($vendor_id != '' || $vendor_id != NULL) {
            if ($is_approved == -1) { // All Design (Pending - Approved - Rejected)
                if (($start_date != '' || $start_date != NULL) && ($end_date != '' || $end_date != NULL)) {
                    $condition = "WHERE `owner_id` = '$vendor_id' AND `upload_date` BETWEEN '$start_date' AND '$end_date' ";
                } else {
                    $condition = "WHERE `owner_id` = '$vendor_id' ";
                }
            } else {
                if (($start_date != '' || $start_date != NULL) && ($end_date != '' || $end_date != NULL)) {
                    $condition = "WHERE `owner_id` = '$vendor_id' AND `is_approved` = '$is_approved' AND `upload_date` BETWEEN '$start_date' AND '$end_date' ";
                } else {
                    $condition = "WHERE `owner_id` = '$vendor_id' AND `is_approved` = '$is_approved' ";
                }
            }
        } else {
            if ($is_approved == -1) { // All Design (Pending - Approved - Rejected)
                if (($start_date != '' || $start_date != NULL) && ($end_date != '' || $end_date != NULL)) {
                    $condition = "WHERE `upload_date` BETWEEN '$start_date' AND '$end_date' ";
                } else {
                    $condition = "";
                }
            } else {
                if (($start_date != '' || $start_date != NULL) && ($end_date != '' || $end_date != NULL)) {
                    $condition = "WHERE `is_approved` = '$is_approved' AND `upload_date` BETWEEN '$start_date' AND '$end_date' ";
                } else {
                    $condition = "WHERE `is_approved` = '$is_approved' ";
                }
            }
        }

        $SQL = "SELECT `is_approved` AS type , count(`is_approved`) AS count FROM `product_designs` " . $condition . " GROUP BY `is_approved` ";
        $result = $connection->fetchAll($SQL);
        return $result;
    }

}
