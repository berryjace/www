<?php $action = Zend_Controller_Front::getInstance()->getRequest()->getActionName(); ?>
<div class="leftalign">
    <a href="<?php echo $this->baseUrl("vendor/royalty/history"); ?>" class="iconlink<?php echo ($action === "history") ? '' : '2'; ?>"><img src="<?php echo $this->baseUrl(); ?>/assets/images/icons/small/<?php echo $action === "history" ? 'white' : 'black'; ?>/settings.png" class="mgright5" alt="" /><span>Royalty Report History</span></a> &nbsp;
    <!-- <a href="<?php echo $this->baseUrl("vendor/royalty/sale-revenue"); ?>" class="iconlink<?php echo ($action === "sale-revenue") ? '' : '2'; ?>"><img src="<?php echo $this->baseUrl(); ?>/assets/images/icons/small/<?php echo $action === "sale-revenue" ? 'white' : 'black'; ?>/plus.png" class="mgright5" alt="" /><span>Add Sale Revenue</span></a>-->
</div>
<div class="spacer clear"></div>

<div class="notification msgalert">
    <a class="close"></a>
     Please fill out the sale revenue summary below. These figures must match the sales detail you have uploaded. If you are declaring any returns, these transactions must also be included in your sales detail. Sales totals must be listed for every licensed group, even if the sales total is $0. Click on the 'Calculate' button when you are done.
</div>
	<h1><?php echo $this->vendor->organization_name;?></h1>
	<h3>Royalty Report Summary</h3>
	<h3>
	<b><span id="quarter_display"><?php echo 'Q'.$this->summary_data['quarter']; ?>
	</span></b>&nbsp;<b><span id="year_display"><?php echo $this->summary_data['fiscal_year']; ?></span> FY (Sales </b><span id="quarter_month_display"><?php if ($this->summary_data['quarter'] == 1){
		echo "July-September ";
	} else if ($this->summary_data['quarter']==2){
		echo "October-December ";
	} else if ($this->summary_data['quarter']==3){
		echo "January-March ";
	} else {
		echo "April-June ";
	}
	echo "</span><span id=\"year_display\">";
	if ($this->summary_data['quarter'] < 2){
	echo substr($this->summary_data['fiscal_year'], 0, 4);
	} else {
	echo substr($this->summary_data['fiscal_year'], 0, 2) . substr($this->summary_data['fiscal_year'], 5, 2);
	}	
	?></span>)
	</h3>
	<br />
<form name="sale_revenue_form" id="sale_revenue_form" action="" method="POST">
    <div class="one">
        <!--<?php
        $current_fiscal_year = Date("Y");
        /**
         * If now is quarter 2 (OCT - DEC), we have to make the default fiscal year in the coming one.
         */
        $select_fiscal_year = $current_fiscal_year.'-'.substr(($current_fiscal_year + 1), 2);
        $current_fiscal_year = BL_AMC::getCurrentQarter() == 2 ? $current_fiscal_year + 1 : $current_fiscal_year;
        $years = range($current_fiscal_year + 1, $current_fiscal_year - 5);
        $year_dropdown_vals = array();
        foreach ($years as $year) {
            $year_dropdown_vals[($year - 1) . "-" . substr($year, 2)] = ($year - 1) . "-" . substr($year, 2);
        }
        echo $this->formLabel("fiscal_year", "Fiscal Year  ");
        echo $this->formSelect("fiscal_year", array($this->year), array(), $year_dropdown_vals);
        ?>
        <?php
        echo str_repeat('&nbsp;', 2);
        echo $this->formLabel("quarter", "Quarter  ");
        echo $this->formSelect("quarter", array($this->quarter), null, array(
            1 => "Q1 (Sales Jul 01 - Sept 30)",
            2 => "Q2 (Sales Oct 01 - Dec 31)",
            3 => "Q3 (Sales Jan 01 - Mar 31)",
            4 => "Q4 (Sales April 01 - Jun 30)"
        ));
        ?>-->
    </div>
    <div class="spacer clear"></div>

    <div class="one">
        <table class="report_submit_table">
        <thead>
            <tr class="sales_row_header">
                <th align="left">Organization Name&nbsp;&nbsp;</th>
                <th align="left">
             <!--    <?php if($this->vendor_reporting_type == 1) {?>
                	Gross Sales Per Quarter
                <?php } elseif ($this->vendor_reporting_type == 2) {?>
                	Number of Units Sold in the Quarter
                <?php } elseif ($this->vendor_reporting_type == 3) {?>
                	Royalty Due Before Applying Advance
                <?php }?> -->
                
                Sub-Total Gross Sales
                &nbsp;&nbsp;&nbsp;&nbsp;</th>
                <th>Actual Returns Declared&nbsp;&nbsp;&nbsp;&nbsp;</th>
                <th>Total Gross Sales&nbsp;&nbsp;&nbsp;&nbsp;</th>
                <th align="left">&nbsp;</th>
            </tr>
        </thead>
        <tbody>
     		<?php if (isset($this->submission_info)){ 
     			$second = 0;
     		foreach($this->submission_info as $clientID => $sales){
     			?>
     		<tr class = "sales_row">
     			<td>
                    <select name="greek_org[]" class="select">
                        <?php foreach ($this->clients as $client): ?>
                            <option value="<?php echo $client->id; ?>"  <?php if ($client->id == $clientID) echo "selected";?>><?php echo $client->organization_name; ?></option>
<!--                                <option value="<?php //echo $client->client_id->id; ?>"><?php //echo $client->client_id->organization_name; ?></option>-->
                        <?php endforeach; ?>
                    </select>&nbsp;&nbsp;
     			</td>
     			<td>
                	<span>$</span><input value="<?php echo $sales ?>" class="subTotalGrossSales money" type="text" name="gross_sales[]"/>
                </td>
                <td>
                	<span>$</span><input class="returnsDeclared" type="text" name="returnsDeclared[]" class="money"/>
                </td>
                <td class="totalColumn" >
                	<span class = "childSpan">$<span class="money"><?php echo $sales ?></span></span>
                </td>
                <td>
                    <a href="javascript:;" class="iconlink add"><img src="<?php echo $this->baseUrl("assets"); ?>/images/icons/small/white/plus.png" alt=""  ></a>
                    <a href="javascript:;" class="iconlink rem <?php if(!$second) echo "hidden";?>"><img src="<?php echo $this->baseUrl("assets"); ?>/images/icons/small/white/minus.png" alt=""  ></a>
                </td>
     		</tr>
     		<?php $second++;} } else if (isset($this->summary_data)){
     			$second = 0;
     			for ($i = 0; $i < count($this->summary_data['gross_sales']); $i ++){

     			?>
     			<tr class="sales_row">
     				<td>
     					<select name="greek_org[]" class="select>
     					<?php foreach($this->clients as $client):?>
     						<option value="<?php echo $client->id;?>" <?php if ($client->id == $this->summary_data['clients_id'][$i]) echo "selected";?>><?php  echo $client->organization_name;?></option>
     						
     					<?php endforeach;?>
     					</select>
     				</td>
     				<td>
     					<span>$</span><input value="<?php echo $this->summary_data['gross_sales'][$i];?>" class = "subTotalGrossSales money" type="text" name="gross_sales[]"/>
     				</td>
     				<td>
     					<span>$</span><input value="<?php echo $this->summary_data['returns'][$i];?>" class="returnsDeclared money" type="text" name="returnsDeclared[]" />
     				</td>
     				<td class="totalColumn">
     				<span class="childSpan">$<?php echo $this->summary_data['gross_sales'][$i] - $this->summary_data['returns'][$i];?></span>
     				</td>
     				<td>
     					<a href="javascript:;" class="iconlink add"><img src="<?php echo $this->baseUrl("assets");?>/images/icons/small/white/plus.png" alt="" ></a>
     					<a href="javascript:;" class="iconlink rem <?php if (!$second) echo "hidden";?>"><img src="<?php echo $this->baseUrl("assets");?>/images/icons/small/white/minus.png" alt="" ></a>
     				</td>
     			</tr>
     		
     		<?php $second++; } } else {?>
            <tr class="sales_row">
                <td>
                    <select name="greek_org[]" class="select">
                        <?php foreach ($this->clients as $client): ?>
                            <option value="<?php echo $client->id; ?>"><?php echo $client->organization_name; ?></option>
<!--                                <option value="<?php //echo $client->client_id->id; ?>"><?php //echo $client->client_id->organization_name; ?></option>-->
                        <?php endforeach; ?>
                    </select>&nbsp;&nbsp;
                </td>
              <!-- <?php error_log("\nvendor_reporting_type " . $this->vendor_reporting_type, 3, "./errorLog.log");?>
               <?php if ($this->vendor_reporting_type == 1) {?>
                <td><?php echo $this->formText("gross_sales[]", "", array('id' => 'royalty_due', 'class' => 'text', 'size' => 10)); ?>&nbsp;&nbsp;</td>
                <?php } elseif ($this->vendor_reporting_type == 2)  {?>
                <td><?php echo $this->formText("qty[]", "", array('id' => 'royalty_due', 'class' => 'text', 'size' => 10)); ?>&nbsp;&nbsp;</td>
                <?php } elseif ($this->vendor_reporting_type == 3)  {?>
                <td><?php echo $this->formText("royalty_due[]", "", array('id' => 'royalty_due', 'class' => 'text', 'size' => 10)); ?>&nbsp;&nbsp;</td>
                <?php }?> -->
                <td>
                	<span>$</span><input class="subTotalGrossSales money" type="text" name="gross_sales[]"/>
                </td>
                <td>
                	<span>$</span><input class="returnsDeclared money" type="text" name="returnsDeclared[]"/>
                </td>
                <td class="totalColumn" >
                	<span class = "childSpan money">$</span>
                </td>
                <td>
                    <a href="javascript:;" class="iconlink add"><img src="<?php echo $this->baseUrl("assets"); ?>/images/icons/small/white/plus.png" alt=""  ></a>
                    <a href="javascript:;" class="iconlink rem hidden"><img src="<?php echo $this->baseUrl("assets"); ?>/images/icons/small/white/minus.png" alt=""  ></a>
                </td>
            </tr>
            <?php } ?>
        </tbody>
    </table>
    </div>
    <div class="spacer clear"></div>
    <button type="button" id="go-back" class="button button_black">Back</button>&nbsp;&nbsp;<button type="submit" id="submit-revenue" class="button button_black">Calculate Royalties</button>&nbsp;
</form>

<style type="text/css">
    div.jGrowl div.jGrowl-notification
    {
        color:#000000;
        background-color:#A79269;
    }
    label{font-weight: bold;}
    .money{text-align: right;}
</style>

<script type="text/javascript">
                
    function refreshItem(row){
    	$(this).change(function(){

			var subtotal = ($(this).parent().parent().find("td > .subTotalGrossSales").val() != '')? $(this).parent().parent().find("td > .subTotalGrossSales").val().replace(",", ""):0;
			var returns = ($(this).parent().parent().find("td>.returnsDeclared").val() != '')? $(this).parent().parent().find("td > .returnsDeclared").val().replace(",", ""):0;
			
			var total = subtotal - returns;

			if (parseInt(total) >= 1000){
				var partA = total % 1000;

				partA = partA.toFixed(2);

				if (partA < 100){
						if (partA < 10){
								partA = "0" + partA;
							}
						partA = "0" + partA;
					}					
				var partB = parseInt(total / 1000);

				total = "$" + partB + "," + partA;
			} else {
				total = "$" + total.toFixed(2);
			}
			
			$(this).parent().parent().find(".totalColumn > .childSpan").text(total);
    	});
    }

	$(document).ready(function(){

		$(".money").each(function(){
			var amnt = parseFloat(($(this).val() != '')? $(this).val():0);
		
			if (amnt >= 1000){
				var partA = amnt %1000;
				var partB = parseInt(amnt/1000);
	
				partA = partA.toFixed(2);
	
				if (partA < 100){
					if (partA < 10){
						partA = "0" + partA;
					}
					partA = "0" + partA;
				}
	
				amnt = partB + "," + partA;	
			} else {
				amnt = amnt.toFixed(2);
			}
	
			$(this).val(amnt);
		});
		
		$(".subTotalGrossSales").each(function(){
			
			var subtotal = ($(this).parent().parent().find("td > .subTotalGrossSales").val() != '')? $(this).parent().parent().find("td > .subTotalGrossSales").val().replace(",", ""):0;
			var returns = ($(this).parent().parent().find("td>.returnsDeclared").val() != '')? $(this).parent().parent().find("td > .returnsDeclared").val().replace(",", ""):0;
			
			var total = subtotal - returns;

			if (parseInt(total) >= 1000){
				var partA = total % 1000;

				partA = partA.toFixed(2);

				if (partA < 100){
						if (partA < 10){
								partA = "0" + partA;
							}
						partA = "0" + partA;
					}					
				var partB = parseInt(total / 1000);

				total = "$" + partB + "," + partA;
			} else {
				total = "$" + total.toFixed(2);
			}

			$(this).parent().parent().find(".totalColumn > .childSpan").text(total);
	
		});
	
		event_functions.setupRows();
		
		
		$(".subTotalGrossSales").each(function(){
				$(this).change(function(){
					console.log("gross changed");

					var subtotal = ($(this).parent().parent().find("td > .subTotalGrossSales").val() != '')? $(this).parent().parent().find("td > .subTotalGrossSales").val().replace(",", ""):0;
					var returns = ($(this).parent().parent().find("td>.returnsDeclared").val() != '')? $(this).parent().parent().find("td > .returnsDeclared").val().replace(",", ""):0;
					
						var total = subtotal - returns;

						if (parseInt(total) >= 1000){
							var partA = total % 1000;

							partA = partA.toFixed(2);

							if (partA < 100){
									if (partA < 10){
											partA = "0" + partA;
										}
									partA = "0" + partA;
								}					
							var partB = parseInt(total / 1000);

							total = "$" + partB + "," + partA;
						} else {
							total = "$" + total.toFixed(2);
						}

						$(this).parent().parent().find(".totalColumn > .childSpan").text(total);
					});
			});
		
		$(".returnsDeclared").each(function(){
			$(this).change(function(){

					console.log("return changed");

					var subtotal = ($(this).parent().parent().find("td > .subTotalGrossSales").val() != '')? $(this).parent().parent().find("td > .subTotalGrossSales").val().replace(",", ""):0;
					var returns = ($(this).parent().parent().find("td>.returnsDeclared").val() != '')? $(this).parent().parent().find("td > .returnsDeclared").val().replace(",", ""):0;
					
					var total = subtotal - returns;

					if (parseInt(total) >= 1000){
						var partA = total % 1000;

						partA = partA.toFixed(2);

						if (partA < 100){
								if (partA < 10){
										partA = "0" + partA;
									}
								partA = "0" + partA;
							}					
						var partB = parseInt(total / 1000);

						total = "$" + partB + "," + partA;
					} else {
						total = "$" + total.toFixed(2);
					}
					
					$(this).parent().parent().find(".totalColumn > .childSpan").text(total);
				});
		});
		
			
	});
                
	$(function(){
		$('form').submit(function(e){
			e.preventDefault();

			$('.money').each(function(){
				$(this).val($(this).val().replace(",", ""));
			});

			$('.totalColumn>.childSpan').each(function(){
				$(this).text($(this).text().replace(",", ""));
			});
			var data = $(this).serialize();
			var qdata = '<?php echo http_build_query(Zend_Controller_Front::getInstance()->getRequest()->getParams())?>'
			if(qdata!='') {
				data = data + '&' + qdata;
			}
			$.ajax({
				'url'	:	site_url+'/vendor/royalty/ajax-submit-report',
				'type'	:	'post',
				'data'	:	data,

				'success':	function(data){
					console.log(data);
					var d = $.parseJSON(data)
					if(d.success == true) {
						window.location.href = site_url+'/vendor/royalty/sale-revenue-review';
					}
				},
				'error': function(XMLHttpRequest, textStatus, errorThrown){

					console.log("error in request ");
                }
				

			})

		});
	})


    $(window).bind('load', function(){
        event_functions._initialize();

        $(document).on('click', 'a.add', event_functions.add_sale_revenue);
        $(document).on('click', 'a.rem', event_functions.remove_sale_revenue);
        $(document).on('click', 'button#go-back', event_functions.go_back);

    });

    event_functions = {
        _initialize : function(){

        },
        go_back : function(){
			window.history.go(-1);
        },
        setupRows : function(){

			console.log("setting up rows");
            
        	$(".money").each(function(){
    			$(this).change(function(){
    				var amnt = parseFloat($(this).val());

					console.log("changed");
    				
    				if (amnt >= 1000){
    					var partA = amnt %1000;
    					var partB = parseInt(amnt/1000);

    					partA = partA.toFixed(2);

    					if (partA < 100){
    						if (partA < 10){
    							partA = "0" + partA;
    						}
    						partA = "0" + partA;
    					}

    					amnt = partB + "," + partA;	
    				} else {
    					amnt = amnt.toFixed(2);
    				}

    				$(this).val(amnt);
    			});
    			
    		});
        },
        add_sale_revenue : function(){
        	event_functions.setupRows();
            $new_row=$(this).parents("tr.sales_row").clone();

			var count = $(this).parents("table").find('tr.sales_row').length;

			console.log(count);

			if (count > 0){
				 $(this).parents("tr.sales_row").find('a.rem').removeClass('hidden');

				 console.log("removing hidden class");
			}
            
            $(this).parents("table").append($new_row);
            $new_row.find('input').val('');
            $new_row.find('.childSpan').text('$');
            $new_row.find('a.add').hide();
            $new_row.find('a.rem').removeClass('hidden');
            $new_row.find('.money').each(function(){
                $(this).change(function(){
                	var amnt = parseFloat($(this).val());

					console.log("changed");
    				
    				if (amnt >= 1000){
    					var partA = amnt %1000;
    					var partB = parseInt(amnt/1000);

    					partA = partA.toFixed(2);

    					if (partA < 100){
    						if (partA < 10){
    							partA = "0" + partA;
    						}
    						partA = "0" + partA;
    					}

    					amnt = partB + "," + partA;	
    				} else {
    					amnt = amnt.toFixed(2);
    				}

    				$(this).val(amnt);
                });
            });
            $new_row.find('.subTotalGrossSales').change(function(){

				var subtotal = ($(this).parent().parent().find("td > .subTotalGrossSales").val() != '')? $(this).parent().parent().find("td > .subTotalGrossSales").val().replace(",", ""):0;
				var returns = ($(this).parent().parent().find("td>.returnsDeclared").val() != '')? $(this).parent().parent().find("td > .returnsDeclared").val().replace(",", ""):0;
				
				var total = subtotal - returns;

				if (parseInt(total) >= 1000){
					var partA = total % 1000;

					partA = partA.toFixed(2);

					if (partA < 100){
							if (partA < 10){
									partA = "0" + partA;
								}
							partA = "0" + partA;
						}					
					var partB = parseInt(total / 1000);

					total = "$" + partB + "," + partA;
				} else {
					total = "$" + total.toFixed(2);
				}
				
				$(this).parent().parent().find(".totalColumn > .childSpan").text(total);
			});
			$new_row.find('.returnsDeclared').change(function(){

				var subtotal = ($(this).parent().parent().find("td > .subTotalGrossSales").val() != '')? $(this).parent().parent().find("td > .subTotalGrossSales").val().replace(",", ""):0;
				var returns = ($(this).parent().parent().find("td>.returnsDeclared").val() != '')? $(this).parent().parent().find("td > .returnsDeclared").val().replace(",", ""):0;
				
				var total = subtotal - returns;

				if (parseInt(total) >= 1000){
					var partA = total % 1000;

					partA = partA.toFixed(2);

					if (partA < 100){
							if (partA < 10){
									partA = "0" + partA;
								}
							partA = "0" + partA;
						}					
					var partB = parseInt(total / 1000);

					total = "$" + partB + "," + partA;
				} else {
					total = "$" + total.toFixed(2);
				}
				
				$(this).parent().parent().find(".totalColumn > .childSpan").text(total);
			});
        },
        remove_sale_revenue : function(){

			var index = $(this).parents('tr.sales_row').prevAll().length;

			if (index == 0){

					console.log("first item being removed");
					$(this).parents('tr.sales_row').next('tr.sales_row').find('a.add').show();
				}

			var count = $(this).parents("table").find('tr.sales_row').length;

			if (count < 3){
					$(this).parents("table").find('tr.sales_row:nth-child(2)').find('a.rem').addClass('hidden');
				}

            
            $(this).parents('tr.sales_row').remove();
			
        }
    }
</script>